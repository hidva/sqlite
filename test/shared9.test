# 2012 October 5
#
# The author disclaims copyright to this source code.  In place of
# a legal notice, here is a blessing:
#
#    May you do good and not evil.
#    May you find forgiveness for yourself and forgive others.
#    May you share freely, never taking more than you give.
#
#***********************************************************************
#
# The tests in this file are intended to show if two connections attach
# to the same shared cache using different database names, views and
# virtual tables may still be accessed.
#

set testdir [file dirname $argv0]
source $testdir/tester.tcl
set testprefix shared9
db close
set enable_shared_cache [sqlite3_enable_shared_cache 1]

# Test organization:
#   
#   1.* - Views.
#   2.* - Virtual tables.
#

sqlite3 db1 test.db
sqlite3 db2 test.db
forcedelete test.db2

do_test 1.1 {
  db1 eval {
    ATTACH 'test.db2' AS 'fred';
    CREATE TABLE fred.t1(a, b, c);
    CREATE VIEW fred.v1 AS SELECT * FROM t1;

    CREATE TABLE fred.t2(a, b);
    CREATE TABLE fred.t3(a, b);
    CREATE TRIGGER fred.trig AFTER INSERT ON t2 BEGIN
      DELETE FROM t3;
      INSERT INTO t3 SELECT * FROM t2;
    END;
    INSERT INTO t2 VALUES(1, 2);
    SELECT * FROM t3;
  }
} {1 2}

do_test 1.2 { db2 eval "ATTACH 'test.db2' AS 'jones'" } {}
do_test 1.2 { db2 eval "SELECT * FROM v1"             } {}
do_test 1.3 { db2 eval "INSERT INTO t2 VALUES(3, 4)"  } {}

do_test 2.1 {
  db1 eval {
    CREATE VIRTUAL TABLE fred.t4 USING fts4;
    INSERT INTO t4 VALUES('hello world');
  }
} {}

do_test 2.2 {
  db2 eval {
    INSERT INTO t4 VALUES('shared cache');
    SELECT * FROM t4 WHERE t4 MATCH 'hello';
  }
} {{hello world}}

do_test 2.3 {
  db1 eval {
    SELECT * FROM t4 WHERE t4 MATCH 'c*';
  }
} {{shared cache}}

db1 close
db2 close
sqlite3_enable_shared_cache $::enable_shared_cache
finish_test

